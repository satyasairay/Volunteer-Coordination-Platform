<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Field Configuration - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold">   Field Worker Form Configuration</h1>
                        <p class="text-indigo-100">Configure which fields are required, optional, or hidden</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="saveBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                               Save Changes
                        </button>
                        <a href="/" class="px-4 py-2 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition">
                            Homepage
                        </a>
                        <a href="/admin" class="px-4 py-2 bg-white text-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition">
                              Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-4 py-8">
            <!-- Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
                <h2 class="text-lg font-bold text-blue-800 mb-2">   Instructions</h2>
                <ul class="list-disc list-inside text-blue-700 space-y-1">
                    <li><strong>Required:</strong> Field must be filled by coordinator</li>
                    <li><strong>Optional:</strong> Field can be left blank</li>
                    <li><strong>Hidden:</strong> Field won't show on the form</li>
                    <li><strong>Drag & Drop:</strong> Reorder fields by dragging the    handle</li>
                    <li>Changes apply immediately after saving - coordinators will see updated form</li>
                </ul>
            </div>

            <!-- Field Configuration Table -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800">Form Fields Configuration</h2>
                    <p class="text-gray-600 text-sm mt-1">12 configurable fields for Field Worker submissions</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Order</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Field Name</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Label</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Required</th>
                                <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Visible</th>
                            </tr>
                        </thead>
                        <tbody id="fieldsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Preview Section -->
            <div class="bg-white rounded-xl shadow-md p-6 mt-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4">    Live Preview</h2>
                <p class="text-gray-600 mb-4">This is how the form will appear to coordinators:</p>
                <div id="formPreview" class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50">
                    <!-- Rendered via JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let fields = [];
        let sortable = null;

        async function loadFields() {
            try {
                const response = await fetch('/api/admin/form-config');
                const data = await response.json();
                fields = data;
                renderTable();
                renderPreview();
                initSortable();
            } catch (error) {
                console.error('Failed to load fields:', error);
                alert('Failed to load field configuration');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('fieldsTableBody');
            tbody.innerHTML = fields.map((field, index) => `
                <tr class="hover:bg-gray-50 transition" data-field-id="${field.id}">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="cursor-move text-gray-400 hover:text-gray-600" title="Drag to reorder">  </span>
                            <span class="text-gray-700 font-semibold">${field.display_order}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <code class="text-sm bg-gray-100 px-2 py-1 rounded">${field.field_name}</code>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-800 font-medium">${field.field_label}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-gray-600 text-sm">${field.field_type}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="sr-only peer" 
                                   ${field.is_required ? 'checked' : ''}
                                   onchange="toggleRequired(${field.id}, this.checked)"
                                   ${field.field_name === 'full_name' || field.field_name === 'phone' || field.field_name === 'designation' ? 'disabled' : ''}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 ${field.field_name === 'full_name' || field.field_name === 'phone' || field.field_name === 'designation' ? 'opacity-50 cursor-not-allowed' : ''}"></div>
                        </label>
                        ${field.field_name === 'full_name' || field.field_name === 'phone' || field.field_name === 'designation' ? '<div class="text-xs text-gray-500 mt-1">Core field</div>' : ''}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   class="sr-only peer" 
                                   ${field.is_visible ? 'checked' : ''}
                                   onchange="toggleVisible(${field.id}, this.checked)">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </td>
                </tr>
            `).join('');
        }

        function renderPreview() {
            const preview = document.getElementById('formPreview');
            const visibleFields = fields.filter(f => f.is_visible).sort((a, b) => a.display_order - b.display_order);
            
            if (visibleFields.length === 0) {
                preview.innerHTML = '<p class="text-gray-500 text-center py-8">No visible fields configured</p>';
                return;
            }

            preview.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${visibleFields.map(field => `
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-gray-700">
                                ${field.field_label}
                                ${field.is_required ? '<span class="text-red-500">*</span>' : '<span class="text-gray-400 text-xs">(Optional)</span>'}
                            </label>
                            ${field.field_type === 'textarea' ? 
                                `<textarea class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" placeholder="${field.placeholder || ''}" rows="3" disabled></textarea>` :
                                field.field_type === 'select' ?
                                `<select class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" disabled><option>${field.placeholder || 'Select...'}</option></select>` :
                                `<input type="${field.field_type}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" placeholder="${field.placeholder || ''}" disabled>`
                            }
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function toggleRequired(fieldId, isRequired) {
            const field = fields.find(f => f.id === fieldId);
            if (field) {
                field.is_required = isRequired;
                renderPreview();
            }
        }

        function toggleVisible(fieldId, isVisible) {
            const field = fields.find(f => f.id === fieldId);
            if (field) {
                field.is_visible = isVisible;
                renderPreview();
            }
        }

        function initSortable() {
            const tbody = document.getElementById('fieldsTableBody');
            if (sortable) {
                sortable.destroy();
            }
            
            sortable = Sortable.create(tbody, {
                animation: 150,
                handle: '.cursor-move',
                onEnd: function(evt) {
                    // Update display_order based on new positions
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        const fieldId = parseInt(row.getAttribute('data-field-id'));
                        const field = fields.find(f => f.id === fieldId);
                        if (field) {
                            field.display_order = index + 1;
                        }
                    });
                    renderTable();
                    renderPreview();
                    initSortable(); // Reinit after render
                }
            });
        }

        async function saveChanges() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = '  Saving...';
            
            try {
                const response = await fetch('/api/admin/form-config', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(fields)
                });

                if (response.ok) {
                    btn.textContent = '  Saved!';
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-green-700');
                    setTimeout(() => {
                        btn.textContent = '   Save Changes';
                        btn.classList.remove('bg-green-700');
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        btn.disabled = false;
                    }, 2000);
                } else {
                    alert('Failed to save changes');
                    btn.disabled = false;
                    btn.textContent = '   Save Changes';
                }
            } catch (error) {
                alert('Network error. Please try again.');
                btn.disabled = false;
                btn.textContent = '   Save Changes';
            }
        }

        document.getElementById('saveBtn').addEventListener('click', saveChanges);
        loadFields();
    </script>
</body>
</html>

