<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seva Atlas - Bhadrak 3D Terrain</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        
        #map { 
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        /* Glassmorphic floating header */
        #header {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .header-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4);
        }
        
        /* Seva Feed Panel */
        #seva-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: white;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(calc(100% - 80px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        #seva-panel.expanded { transform: translateY(0); }
        
        .panel-handle {
            width: 40px;
            height: 5px;
            background: #d1d5db;
            border-radius: 3px;
            margin: 12px auto 8px;
            cursor: pointer;
        }
        
        .panel-header {
            padding: 12px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }
        
        .seva-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        @media (max-width: 768px) {
            #header { padding: 10px 16px; }
            #header h1 { font-size: 16px; }
            .header-btn { padding: 6px 12px; font-size: 12px; }
        }
        
        /* Mapbox controls styling */
        .mapboxgl-ctrl-group {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px);
            border-radius: 12px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }
        
        .mapboxgl-ctrl-group button {
            border-radius: 8px !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <h1>üïâÔ∏è Seva Atlas</h1>
        <span style="color: #6b7280; font-size: 14px;">üìç Bhadrak</span>
        <button class="header-btn btn-primary" onclick="toggleSevaPanel()">üî• Seva Feed</button>
        <a href="/doctors" class="header-btn" style="background: rgba(255,255,255,0.5); color: #1f2937; text-decoration: none;">üë®‚Äç‚öïÔ∏è Doctors</a>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Seva Feed Panel -->
    <div id="seva-panel">
        <div class="panel-handle" onclick="toggleSevaPanel()"></div>
        <div class="panel-header">
            <h2 style="font-size: 18px; font-weight: 700; margin: 0;">Active Seva Requests</h2>
            <span id="seva-count" style="background: #f97316; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600;">0</span>
        </div>
        <div id="seva-feed" class="panel-content">
            <p style="color: #6b7280;">Loading seva activities...</p>
        </div>
    </div>

    <script>
        // Get Mapbox token from server
        const MAPBOX_TOKEN = '{{ mapbox_token }}';
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Initialize Mapbox GL map with 3D terrain
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/outdoors-v12',
            center: [86.52, 21.05], // Bhadrak center
            zoom: 9.5,
            pitch: 60, // Dramatic 3D tilt
            bearing: -20, // Slight rotation
            antialias: true
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl({
            visualizePitch: true
        }), 'bottom-right');

        // Add 3D terrain on load
        map.on('load', () => {
            // Add Mapbox Terrain DEM source
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });

            // Enable 3D terrain with exaggeration
            map.setTerrain({ 
                'source': 'mapbox-dem', 
                'exaggeration': 2.5 // Dramatic elevation like Switzerland
            });

            // Add sky layer for atmospheric effect
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });

            // Load Bhadrak boundary
            loadBhadrakBoundary();
            
            // Load seva data
            loadSevaFeed();
            loadVillages();
        });

        let bhadrakPolygonCoords = null;

        function loadBhadrakBoundary() {
            fetch('/static/geojson/bhadrak_boundary.geojson')
                .then(res => res.json())
                .then(data => {
                    // Store for point-in-polygon
                    if (data.features && data.features[0] && data.features[0].geometry) {
                        const coords = data.features[0].geometry.coordinates[0];
                        bhadrakPolygonCoords = Array.isArray(coords[0][0]) ? coords[0] : coords;
                    }

                    // Add Bhadrak boundary as fill layer
                    map.addSource('bhadrak-boundary', {
                        'type': 'geojson',
                        'data': data
                    });

                    // Add dramatic glowing fill
                    map.addLayer({
                        'id': 'bhadrak-fill',
                        'type': 'fill',
                        'source': 'bhadrak-boundary',
                        'paint': {
                            'fill-color': '#f97316',
                            'fill-opacity': 0.15
                        }
                    });

                    // Add thick glowing outline
                    map.addLayer({
                        'id': 'bhadrak-outline',
                        'type': 'line',
                        'source': 'bhadrak-boundary',
                        'paint': {
                            'line-color': '#f97316',
                            'line-width': 5,
                            'line-opacity': 1,
                            'line-dasharray': [2, 1]
                        }
                    });

                    // Add outer glow
                    map.addLayer({
                        'id': 'bhadrak-glow',
                        'type': 'line',
                        'source': 'bhadrak-boundary',
                        'paint': {
                            'line-color': '#f97316',
                            'line-width': 15,
                            'line-opacity': 0.3,
                            'line-blur': 10
                        }
                    });

                    // Fit to Bhadrak bounds
                    const bounds = new mapboxgl.LngLatBounds();
                    bhadrakPolygonCoords.forEach(coord => {
                        bounds.extend([coord[0], coord[1]]);
                    });
                    map.fitBounds(bounds, { padding: 100, pitch: 60, bearing: -20 });
                });
        }

        function loadVillages() {
            fetch('/api/villages')
                .then(res => res.json())
                .then(villages => {
                    villages.forEach(v => {
                        if (v.latitude && v.longitude) {
                            const el = document.createElement('div');
                            el.className = 'marker';
                            el.style.cssText = `
                                background: #f97316;
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 8px rgba(249, 115, 22, 0.6);
                                animation: pulse 2s infinite;
                            `;

                            new mapboxgl.Marker(el)
                                .setLngLat([v.longitude, v.latitude])
                                .setPopup(new mapboxgl.Popup({ offset: 25 })
                                    .setHTML(`<strong>${v.name}</strong><br>Block: ${v.block || 'N/A'}`))
                                .addTo(map);
                        }
                    });
                });
        }

        function loadSevaFeed() {
            fetch('/api/seva/feed?limit=20')
                .then(res => res.json())
                .then(data => {
                    const feed = document.getElementById('seva-feed');
                    const count = document.getElementById('seva-count');
                    
                    if (data.length === 0) {
                        feed.innerHTML = '<p style="color: #6b7280;">No active seva requests at the moment.</p>';
                        count.textContent = '0';
                        return;
                    }

                    count.textContent = data.length;
                    feed.innerHTML = data.map(item => {
                        if (item.type === 'seva_request') {
                            return `
                                <div class="seva-item">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <strong style="color: #1f2937;">${item.title}</strong>
                                        <span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 8px; font-size: 12px;">${item.status}</span>
                                    </div>
                                    <p style="color: #6b7280; font-size: 14px; margin: 8px 0;">${item.description}</p>
                                    <div style="font-size: 12px; color: #9ca3af; margin-top: 8px;">
                                        üìç ${item.village} | üìÖ ${new Date(item.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                });
        }

        function toggleSevaPanel() {
            document.getElementById('seva-panel').classList.toggle('expanded');
        }

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { 
                    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.6), 0 0 0 0 rgba(249, 115, 22, 0.7);
                }
                50% { 
                    box-shadow: 0 2px 8px rgba(249, 115, 22, 0.8), 0 0 0 8px rgba(249, 115, 22, 0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
