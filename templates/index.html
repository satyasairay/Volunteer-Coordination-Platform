<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seva Atlas - Bhadrak, Odisha</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        /* Full screen map */
        #map { 
            height: 100vh; 
            width: 100%; 
            position: relative;
        }
        
        /* Glass overlay for non-Bhadrak areas */
        .glass-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, 
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.4) 30%,
                rgba(255, 255, 255, 0.6) 60%,
                rgba(255, 255, 255, 0.75) 100%
            );
            pointer-events: none;
            z-index: 400;
            backdrop-filter: blur(1px);
            mix-blend-mode: lighten;
        }
        
        /* 3D Bhadrak boundary - elevated effect */
        .bhadrak-3d {
            filter: drop-shadow(0 4px 12px rgba(249, 115, 22, 0.5)) 
                    drop-shadow(0 8px 24px rgba(249, 115, 22, 0.3))
                    drop-shadow(0 -2px 6px rgba(255, 255, 255, 0.4))
                    brightness(1.15) contrast(1.1);
        }
        
        /* Pulsing glow for Bhadrak */
        @keyframes bhadrak-glow {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(249, 115, 22, 0.6)) brightness(1.15);
            }
            50% { 
                filter: drop-shadow(0 0 40px rgba(249, 115, 22, 0.8)) brightness(1.25);
            }
        }
        
        /* Glassmorphic floating header */
        #header {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            white-space: nowrap;
        }
        
        .header-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            color: #1f2937;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.8);
        }
        
        /* Mobile header */
        @media (max-width: 768px) {
            #header {
                top: 12px;
                padding: 10px 16px;
                gap: 8px;
                border-radius: 40px;
            }
            #header h1 { font-size: 16px; }
            .header-btn { padding: 6px 12px; font-size: 12px; }
            .hide-mobile { display: none; }
        }
        
        /* Seva Feed Panel - Mobile optimized */
        #seva-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: white;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(calc(100% - 80px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        #seva-panel.expanded {
            transform: translateY(0);
        }
        
        .panel-handle {
            width: 40px;
            height: 5px;
            background: #d1d5db;
            border-radius: 3px;
            margin: 12px auto 8px;
            cursor: pointer;
        }
        
        .panel-header {
            padding: 0 20px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* Desktop seva panel */
        @media (min-width: 769px) {
            #seva-panel {
                right: 16px;
                left: auto;
                bottom: 16px;
                top: 90px;
                width: 380px;
                max-height: none;
                transform: translateX(420px);
                border-radius: 24px;
            }
            
            #seva-panel.expanded {
                transform: translateX(0);
            }
            
            .panel-handle { display: none; }
            .panel-header { cursor: default; }
        }
        
        /* Seva item cards */
        .seva-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #f3f4f6;
            transition: all 0.2s;
        }
        
        .seva-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .urgency-critical { border-left: 4px solid #dc2626; }
        .urgency-high { border-left: 4px solid #f59e0b; }
        .urgency-medium { border-left: 4px solid #3b82f6; }
        .urgency-low { border-left: 4px solid #10b981; }
        
        /* Stats pill */
        #stats-pill {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 900;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        @media (min-width: 769px) {
            #stats-pill {
                bottom: 24px;
                left: 24px;
                transform: none;
            }
        }
        
        /* Coming Soon Modal */
        #coming-soon-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        #coming-soon-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Custom markers */
        .pulse-marker {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Bhadrak district highlight */
        .bhadrak-highlight {
            fill: rgba(249, 115, 22, 0.1);
            stroke: #f97316;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            animation: dashAnimation 20s linear infinite;
        }
        
        @keyframes dashAnimation {
            to { stroke-dashoffset: -100; }
        }
        
        /* Remove default leaflet attribution */
        .leaflet-control-attribution {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 2px 8px;
        }
        
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-critical { background: #fee2e2; color: #dc2626; }
        .badge-high { background: #fef3c7; color: #f59e0b; }
        .badge-medium { background: #dbeafe; color: #3b82f6; }
        .badge-low { background: #d1fae5; color: #10b981; }
        .badge-open { background: #dbeafe; color: #3b82f6; }
        .badge-assigned { background: #fef3c7; color: #f59e0b; }
        .badge-fulfilled { background: #d1fae5; color: #10b981; }
    </style>
</head>
<body>
    <!-- Glassmorphic Header -->
    <div id="header">
        <h1>üïâÔ∏è Seva Atlas</h1>
        <button class="header-btn btn-secondary hide-mobile" onclick="map.flyTo([21.05, 86.52], 10)">
            üìç Bhadrak
        </button>
        <button class="header-btn btn-primary" onclick="toggleSevaPanel()">
            üôè Seva Feed
        </button>
        <a href="/doctors" class="header-btn btn-secondary hide-mobile" style="text-decoration: none;">
            üë®‚Äç‚öïÔ∏è Doctors
        </a>
    </div>

    <!-- Stats Pill -->
    <div id="stats-pill">
        <span id="active-seva-count">0</span> Active Seva Requests
    </div>

    <!-- Map Container -->
    <div id="map"></div>
    
    <!-- Seva Feed Panel -->
    <div id="seva-panel">
        <div class="panel-handle" onclick="toggleSevaPanel()"></div>
        <div class="panel-header" onclick="toggleSevaPanel()">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="font-size: 18px; font-weight: 700; margin: 0; color: #1f2937;">Live Seva Feed</h2>
                    <p style="font-size: 13px; color: #6b7280; margin: 4px 0 0;">Community service updates</p>
                </div>
                <span style="font-size: 24px;">üôè</span>
            </div>
        </div>
        <div class="panel-content" id="feed-container">
            <div style="text-align: center; padding: 40px 20px; color: #9ca3af;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                <p>Loading seva activities...</p>
            </div>
        </div>
    </div>
    
    <!-- Coming Soon Modal -->
    <div id="coming-soon-modal" onclick="hideComingSoonModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="font-size: 64px; margin-bottom: 16px;">üôè</div>
            <h2 style="font-size: 24px; font-weight: 700; margin: 0 0 12px; color: #1f2937;">
                Expanding Soon
            </h2>
            <p style="color: #6b7280; margin: 0 0 24px; line-height: 1.6;">
                Currently serving <strong>Bhadrak District</strong> only.<br>
                More regions coming soon!
            </p>
            <button class="header-btn btn-primary" onclick="hideComingSoonModal()" style="width: 100%;">
                Got it
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialize map - Start at Bhadrak, restrict to India
        const map = L.map('map', {
            center: [21.05, 86.52],
            zoom: 10,
            minZoom: 5,
            maxZoom: 18,
            zoomControl: false,
            maxBounds: [[6, 68], [36, 98]], // India bounds
            maxBoundsViscosity: 0.9
        });

        // Add zoom control to bottom right
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Base topographical layer
        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap',
            maxZoom: 17,
            opacity: 1.0
        });

        // Hillshade layer for 3D terrain effect
        const hillshadeLayer = L.tileLayer('https://tiles.wmflabs.org/hillshading/{z}/{x}/{y}.png', {
            attribution: 'Hillshading',
            maxZoom: 17,
            opacity: 0.4
        });

        // Add layers
        topoLayer.addTo(map);
        hillshadeLayer.addTo(map);

        // Load and highlight Bhadrak district boundary with 3D effects
        let bhadrakBoundary = null;
        let bhadrakMask = null;
        
        fetch('/static/geojson/bhadrak_boundary.geojson')
            .then(res => res.json())
            .then(data => {
                // Store polygon coordinates for point-in-polygon check
                if (data.features && data.features[0] && data.features[0].geometry) {
                    const coords = data.features[0].geometry.coordinates[0];
                    if (Array.isArray(coords[0][0])) {
                        // MultiPolygon or nested array
                        bhadrakPolygonCoords = coords[0];
                    } else {
                        bhadrakPolygonCoords = coords;
                    }
                }
                
                // Create dramatic 3D boundary for Bhadrak
                bhadrakBoundary = L.geoJSON(data, {
                    style: {
                        fillColor: 'transparent',
                        fillOpacity: 0,
                        color: '#f97316',
                        weight: 5,
                        opacity: 1,
                        dashArray: '15, 10',
                        className: 'bhadrak-3d'
                    },
                    onEachFeature: function(feature, layer) {
                        // Add pulsing animation
                        const element = layer.getElement();
                        if (element) {
                            element.style.animation = 'bhadrak-glow 3s ease-in-out infinite';
                            element.style.strokeLinecap = 'round';
                            element.style.strokeLinejoin = 'round';
                        }
                    }
                }).addTo(map);
                
                // Create inverse mask for glass overlay (glass everywhere EXCEPT Bhadrak)
                createGlassMask(data);
                
                // Zoom to Bhadrak bounds with padding
                map.fitBounds(bhadrakBoundary.getBounds(), {
                    padding: [50, 50],
                    maxZoom: 10
                });
            });
        
        // Create SVG clipping mask for glass overlay
        function createGlassMask(bhadrakData) {
            const svg = d3.select(map.getPanes().overlayPane)
                .append('svg')
                .attr('class', 'glass-mask-layer')
                .style('position', 'absolute')
                .style('top', 0)
                .style('left', 0)
                .style('width', '100%')
                .style('height', '100%')
                .style('pointer-events', 'none')
                .style('z-index', 401);
            
            const g = svg.append('g').attr('class', 'leaflet-zoom-hide');
            
            function updateMask() {
                const bounds = map.getBounds();
                const topLeft = map.latLngToLayerPoint(bounds.getNorthWest());
                const bottomRight = map.latLngToLayerPoint(bounds.getSouthEast());
                
                svg.attr('width', bottomRight.x - topLeft.x)
                   .attr('height', bottomRight.y - topLeft.y)
                   .style('left', topLeft.x + 'px')
                   .style('top', topLeft.y + 'px');
                
                g.attr('transform', `translate(${-topLeft.x},${-topLeft.y})`);
                
                // Draw full screen rectangle
                const worldRect = [[bounds.getNorth(), bounds.getWest()],
                                  [bounds.getSouth(), bounds.getEast()]];
                
                // Convert Bhadrak polygon to screen coordinates
                const bhadrakPoints = bhadrakPolygonCoords.map(coord => {
                    const point = map.latLngToLayerPoint([coord[1], coord[0]]);
                    return [point.x, point.y];
                });
                
                // Create path with hole (glass everywhere except Bhadrak)
                g.selectAll('*').remove();
                
                const path = g.append('path')
                    .datum({
                        outer: worldRect,
                        hole: bhadrakPoints
                    })
                    .attr('d', d => {
                        const outerTopLeft = map.latLngToLayerPoint(d.outer[0]);
                        const outerBottomRight = map.latLngToLayerPoint(d.outer[1]);
                        
                        // Outer rectangle (whole screen)
                        let pathStr = `M ${outerTopLeft.x} ${outerTopLeft.y} `;
                        pathStr += `L ${outerBottomRight.x} ${outerTopLeft.y} `;
                        pathStr += `L ${outerBottomRight.x} ${outerBottomRight.y} `;
                        pathStr += `L ${outerTopLeft.x} ${outerBottomRight.y} Z `;
                        
                        // Inner hole (Bhadrak polygon)
                        pathStr += `M ${d.hole[0][0]} ${d.hole[0][1]} `;
                        for (let i = 1; i < d.hole.length; i++) {
                            pathStr += `L ${d.hole[i][0]} ${d.hole[i][1]} `;
                        }
                        pathStr += 'Z';
                        
                        return pathStr;
                    })
                    .attr('fill', 'rgba(255, 255, 255, 0.65)')
                    .attr('fill-rule', 'evenodd')
                    .style('backdrop-filter', 'blur(2px)');
            }
            
            map.on('zoomend moveend', updateMask);
            updateMask();
        }

        // Coming Soon Modal Functions
        function showComingSoonModal() {
            document.getElementById('coming-soon-modal').classList.add('show');
        }

        function hideComingSoonModal() {
            document.getElementById('coming-soon-modal').classList.remove('show');
        }

        // Point-in-polygon check for Bhadrak boundary
        function isPointInPolygon(latlng, polygon) {
            const x = latlng.lat, y = latlng.lng;
            let inside = false;
            
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const xi = polygon[i][1], yi = polygon[i][0];
                const xj = polygon[j][1], yj = polygon[j][0];
                
                const intersect = ((yi > y) !== (yj > y))
                    && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            
            return inside;
        }
        
        // Check if click is outside Bhadrak (true point-in-polygon)
        let bhadrakPolygonCoords = null;
        map.on('click', function(e) {
            if (bhadrakPolygonCoords) {
                const inside = isPointInPolygon(e.latlng, bhadrakPolygonCoords);
                if (!inside) {
                    showComingSoonModal();
                }
            }
        });

        // Seva Panel Toggle
        function toggleSevaPanel() {
            document.getElementById('seva-panel').classList.toggle('expanded');
        }

        // Custom pulsing marker icon for active seva
        const pulsingIcon = L.divIcon({
            className: 'pulse-marker',
            html: '<div style="background: #f97316; width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); animation: pulse 2s infinite;"></div>',
            iconSize: [12, 12]
        });

        // Load villages
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);">${count}</div>`,
                    className: '',
                    iconSize: [40, 40]
                });
            }
        });

        let villagesData = [];

        fetch('/api/villages')
            .then(res => res.json())
            .then(villages => {
                villagesData = villages;
                villages.forEach(v => {
                    const marker = L.marker([v.lat, v.lng], {
                        icon: pulsingIcon,
                        title: v.name
                    });
                    
                    marker.on('click', async () => {
                        const res = await fetch(`/api/village/${v.id}/volunteers`);
                        const members = await res.json();
                        
                        let content = `
                            <div style="font-family: system-ui; min-width: 250px;">
                                <h3 style="font-size: 18px; font-weight: 700; margin: 0 0 8px; color: #1f2937;">${v.name}</h3>
                                <p style="font-size: 13px; color: #6b7280; margin: 0 0 16px;">üìç ${v.block} Block</p>
                        `;
                        
                        if (members.length === 0) {
                            content += '<p style="color: #9ca3af; font-style: italic;">No verified volunteers yet</p>';
                        } else {
                            content += '<div style="max-height: 300px; overflow-y: auto;">';
                            members.forEach(m => {
                                content += `
                                    <div style="border-bottom: 1px solid #f3f4f6; padding: 12px 0;">
                                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">${m.full_name}</div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 6px;">${m.role}</div>
                                        <a href="tel:${m.phone}" style="color: #f97316; font-size: 14px; font-weight: 600; text-decoration: none;">üìû ${m.phone}</a>
                                        ${m.languages ? `<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">üó£Ô∏è ${m.languages}</div>` : ''}
                                    </div>
                                `;
                            });
                            content += '</div>';
                        }
                        content += '</div>';
                        
                        marker.bindPopup(content, { 
                            maxWidth: 320,
                            className: 'custom-popup'
                        }).openPopup();
                    });
                    
                    markers.addLayer(marker);
                });
                
                map.addLayer(markers);
            });

        // Load Seva Feed (read-only)
        let activeSevaCount = 0;

        async function loadSevaFeed() {
            try {
                const response = await fetch('/api/seva/feed?limit=20');
                const data = await response.json();
                renderFeed(data.feed);
                
                // Count active requests
                const reqResponse = await fetch('/api/seva/requests?status=open');
                const reqData = await reqResponse.json();
                activeSevaCount = reqData.requests.length;
                document.getElementById('active-seva-count').textContent = activeSevaCount;
            } catch (error) {
                document.getElementById('feed-container').innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading feed</div>';
            }
        }

        function renderFeed(feedItems) {
            const container = document.getElementById('feed-container');
            
            if (!feedItems || feedItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 64px; margin-bottom: 16px;">üôè</div>
                        <p style="font-weight: 600; font-size: 16px; color: #6b7280;">No seva activity yet</p>
                        <p style="font-size: 14px; margin-top: 8px;">Service requests will appear here</p>
                    </div>
                `;
                return;
            }
            
            const html = feedItems.map(item => {
                if (item.type === 'request') {
                    const icon = {
                        'medical': 'üè•',
                        'electrical': '‚ö°',
                        'plumbing': 'üîß',
                        'spiritual': 'üôè',
                        'emergency': 'üö®',
                        'other': 'üõ†Ô∏è'
                    }[item.seva_type] || 'üìã';
                    
                    return `
                        <div class="seva-card urgency-${item.urgency}">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 28px;">${icon}</div>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 15px; font-weight: 700; margin: 0 0 6px; color: #1f2937;">${item.title}</h3>
                                    <p style="font-size: 13px; color: #6b7280; margin: 0 0 10px;">
                                        <strong>${item.requested_by}</strong> ‚Ä¢ ${item.village_name}
                                    </p>
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        <span class="badge badge-${item.urgency}">${item.urgency}</span>
                                        <span class="badge badge-${item.status}">${item.status}</span>
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: #9ca3af; white-space: nowrap;">
                                    ${getTimeAgo(item.created_at)}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'testimonial') {
                    return `
                        <div class="seva-card" style="border-left: 4px solid #f59e0b;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 28px;">üíê</div>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 15px; font-weight: 700; margin: 0 0 6px; color: #1f2937;">Gratitude</h3>
                                    <p style="font-size: 13px; color: #6b7280; margin: 0 0 10px;">
                                        ${item.author_name}${item.village_name ? ' ‚Ä¢ ' + item.village_name : ''}
                                    </p>
                                    <p style="font-size: 14px; color: #374151; font-style: italic; line-height: 1.5;">"${item.content}"</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            container.innerHTML = html || '<div style="padding: 20px; text-align: center; color: #9ca3af;">No activity to show</div>';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }

        // Load feed on page load and auto-refresh
        loadSevaFeed();
        setInterval(loadSevaFeed, 30000);
    </script>
</body>
</html>
