<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seva Atlas - Bhadrak 3D Terrain</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #1a1a1a; }
        
        /* Full screen map */
        #map { 
            height: 100vh; 
            width: 100%; 
            position: relative;
            background: linear-gradient(180deg, #2c3e50 0%, #3d5a80 50%, #98c1d9 100%);
        }
        
        /* 3D elevation color overlay */
        .leaflet-tile-pane {
            position: relative;
        }
        
        /* Hypsometric tinting - elevation colors */
        .leaflet-overlay-pane canvas {
            mix-blend-mode: multiply;
            opacity: 0.7;
        }
        
        /* Glassmorphic floating header */
        #header {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #header h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .header-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(249, 115, 22, 0.5);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Seva Feed Panel */
        #seva-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.3);
            transform: translateY(calc(100% - 80px));
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #seva-panel.expanded { transform: translateY(0); }
        
        .panel-handle {
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin: 12px auto 8px;
            cursor: pointer;
        }
        
        .panel-header {
            padding: 12px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 24px;
        }
        
        .seva-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            color: white;
        }
        
        @media (max-width: 768px) {
            #header { padding: 10px 16px; gap: 8px; }
            #header h1 { font-size: 16px; }
            .header-btn { padding: 6px 12px; font-size: 12px; }
        }
        
        /* Bhadrak 3D boundary with dramatic glow */
        .bhadrak-boundary {
            stroke: #f97316 !important;
            stroke-width: 6px !important;
            fill: none !important;
            filter: drop-shadow(0 0 20px rgba(249, 115, 22, 0.8))
                    drop-shadow(0 0 40px rgba(249, 115, 22, 0.6))
                    drop-shadow(0 0 60px rgba(249, 115, 22, 0.4));
            animation: glow-pulse 3s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { 
                filter: drop-shadow(0 0 20px rgba(249, 115, 22, 0.8))
                        drop-shadow(0 0 40px rgba(249, 115, 22, 0.6))
                        drop-shadow(0 0 60px rgba(249, 115, 22, 0.4));
            }
            50% { 
                filter: drop-shadow(0 0 30px rgba(249, 115, 22, 1))
                        drop-shadow(0 0 60px rgba(249, 115, 22, 0.8))
                        drop-shadow(0 0 90px rgba(249, 115, 22, 0.6));
            }
        }
        
        /* Custom marker pulse */
        @keyframes marker-pulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7), 0 2px 8px rgba(249, 115, 22, 0.6);
            }
            50% { 
                box-shadow: 0 0 0 12px rgba(249, 115, 22, 0), 0 2px 8px rgba(249, 115, 22, 0.8);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <h1>üïâÔ∏è Seva Atlas</h1>
        <span style="color: rgba(255,255,255,0.7); font-size: 14px;">üìç Bhadrak</span>
        <button class="header-btn btn-primary" onclick="toggleSevaPanel()">üî• Seva Feed</button>
        <a href="/doctors" class="header-btn btn-secondary" style="text-decoration: none;">üë®‚Äç‚öïÔ∏è Doctors</a>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Seva Feed Panel -->
    <div id="seva-panel">
        <div class="panel-handle" onclick="toggleSevaPanel()"></div>
        <div class="panel-header">
            <h2 style="font-size: 18px; font-weight: 700; margin: 0;">Active Seva Requests</h2>
            <span id="seva-count" style="background: #f97316; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: 600;">0</span>
        </div>
        <div id="seva-feed" class="panel-content">
            <p style="color: rgba(255,255,255,0.6);">Loading seva activities...</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [21.05, 86.42], // Shifted west to avoid ocean
            zoom: 10,
            minZoom: 9,
            maxZoom: 16,
            zoomControl: false,
            maxBounds: [[20.7, 86.0], [21.4, 86.9]], // Tight bounds around Bhadrak land area
            maxBoundsViscosity: 1.0
        });

        // Add zoom control
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // Use OpenTopoMap for terrain
        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap',
            maxZoom: 17
        }).addTo(map);

        // Add Esri World Hillshade for 3D relief
        const hillshadeLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Hillshade/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri',
            maxZoom: 16,
            opacity: 0.65
        }).addTo(map);

        let bhadrakPolygonCoords = null;
        let bhadrakBoundary = null;

        // Load village-level boundaries
        let villagesLayer = null;
        fetch('/static/geojson/bhadrak_villages.geojson')
            .then(res => res.json())
            .then(data => {
                // Extract district boundary from villages
                const allCoords = [];
                data.features.forEach(f => {
                    if (f.geometry.coordinates && f.geometry.coordinates[0]) {
                        allCoords.push(...f.geometry.coordinates[0]);
                    }
                });
                bhadrakPolygonCoords = allCoords;
                
                // Add village boundaries with block colors
                villagesLayer = L.geoJSON(data, {
                    style: feature => {
                        const block = feature.properties.SUB_DIST || '';
                        return {
                            fillColor: getBlockColor(block),
                            fillOpacity: 0.25,
                            color: '#444',
                            weight: 0.5,
                            opacity: 0.6
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        
                        // Hover effect
                        layer.on('mouseover', function() {
                            this.setStyle({
                                weight: 2,
                                color: '#f97316',
                                fillOpacity: 0.5
                            });
                        });
                        
                        layer.on('mouseout', function() {
                            villagesLayer.resetStyle(this);
                        });
                        
                        // Click to zoom
                        layer.on('click', function(e) {
                            L.DomEvent.stopPropagation(e);
                            map.fitBounds(layer.getBounds(), { 
                                maxZoom: 14,
                                padding: [50, 50]
                            });
                        });
                        
                        // Popup with village info
                        layer.bindPopup(`
                            <div style="font-family: system-ui;">
                                <strong style="font-size: 16px; color: #1f2937;">${props.NAME}</strong><br>
                                <span style="color: #6b7280; font-size: 14px;">üìç Block: ${props.SUB_DIST || 'N/A'}</span><br>
                                <span style="color: #6b7280; font-size: 12px;">Type: ${props.TYPE}</span>
                            </div>
                        `, {
                            maxWidth: 250
                        });
                    }
                }).addTo(map);
                
                // Add district outer boundary (orange glow)
                bhadrakBoundary = L.geoJSON(data, {
                    style: {
                        color: '#f97316',
                        weight: 6,
                        opacity: 1,
                        fill: false,
                        className: 'bhadrak-boundary',
                        dashArray: '20, 10',
                        lineCap: 'round',
                        lineJoin: 'round'
                    }
                }).addTo(map);
                
                // Add hypsometric elevation overlay (canvas-based)
                addElevationOverlay();
                
                // Zoom to all villages
                map.fitBounds(villagesLayer.getBounds(), { padding: [50, 50] });
            });
        
        // Get block color
        function getBlockColor(block) {
            const colors = {
                'Bhadrak': '#f97316',
                'Basudevpur': '#3b82f6',
                'Chandabali': '#10b981',
                'Dhamnagar': '#a855f7',
                'Dhamanagar': '#a855f7',
                'Tihidi': '#ef4444',
                'Bhandaripokhari': '#eab308',
                'Bonth': '#ec4899',
                'Bant': '#ec4899'
            };
            for (let key in colors) {
                if (block && block.toLowerCase().includes(key.toLowerCase())) {
                    return colors[key];
                }
            }
            return '#9ca3af';
        }

        // Add custom elevation color overlay
        function addElevationOverlay() {
            const ElevationOverlay = L.Layer.extend({
                onAdd: function(map) {
                    this._map = map;
                    this._canvas = L.DomUtil.create('canvas');
                    this._canvas.style.position = 'absolute';
                    this._canvas.style.pointerEvents = 'none';
                    
                    const pane = map.getPanes().overlayPane;
                    pane.appendChild(this._canvas);
                    
                    map.on('moveend zoom viewreset', this._update, this);
                    this._update();
                },
                
                _update: function() {
                    if (!bhadrakPolygonCoords) return;
                    
                    const size = this._map.getSize();
                    const bounds = this._map.getBounds();
                    
                    this._canvas.width = size.x;
                    this._canvas.height = size.y;
                    
                    const ctx = this._canvas.getContext('2d');
                    ctx.clearRect(0, 0, size.x, size.y);
                    
                    // Convert Bhadrak polygon to pixels
                    const pixelPoints = bhadrakPolygonCoords.map(coord => {
                        return this._map.latLngToContainerPoint([coord[1], coord[0]]);
                    });
                    
                    // Create Bhadrak region clip
                    ctx.save();
                    ctx.beginPath();
                    pixelPoints.forEach((point, i) => {
                        if (i === 0) ctx.moveTo(point.x, point.y);
                        else ctx.lineTo(point.x, point.y);
                    });
                    ctx.closePath();
                    ctx.clip();
                    
                    // Draw elevation gradient (green->yellow->orange->brown)
                    const gradient = ctx.createLinearGradient(0, size.y, 0, 0);
                    gradient.addColorStop(0, 'rgba(76, 175, 80, 0.3)');    // Green - low elevation
                    gradient.addColorStop(0.4, 'rgba(255, 235, 59, 0.25)'); // Yellow
                    gradient.addColorStop(0.7, 'rgba(255, 152, 0, 0.3)');   // Orange
                    gradient.addColorStop(1, 'rgba(121, 85, 72, 0.4)');     // Brown - high elevation
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, size.x, size.y);
                    
                    ctx.restore();
                    
                    // Darken surrounding areas dramatically
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
                    ctx.fillRect(0, 0, size.x, size.y);
                    
                    // Cut out Bhadrak again
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.beginPath();
                    pixelPoints.forEach((point, i) => {
                        if (i === 0) ctx.moveTo(point.x, point.y);
                        else ctx.lineTo(point.x, point.y);
                    });
                    ctx.closePath();
                    ctx.fill();
                }
            });
            
            new ElevationOverlay().addTo(map);
        }

        // Load villages with custom markers
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            iconCreateFunction: function(cluster) {
                const count = cluster.getChildCount();
                return L.divIcon({
                    html: `<div style="background: linear-gradient(135deg, #f97316, #ea580c); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-weight: 700; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.5);">${count}</div>`,
                    className: '',
                    iconSize: [40, 40]
                });
            }
        });

        fetch('/api/villages')
            .then(res => res.json())
            .then(villages => {
                villages.forEach(v => {
                    if (v.lat && v.lng) {
                        const icon = L.divIcon({
                            html: '<div style="background: #f97316; width: 14px; height: 14px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(249, 115, 22, 0.7); animation: marker-pulse 2s infinite;"></div>',
                            className: '',
                            iconSize: [14, 14]
                        });

                        const marker = L.marker([v.lat, v.lng], { icon });
                        marker.bindPopup(`<strong>${v.name}</strong><br>Block: ${v.block || 'N/A'}`);
                        markers.addLayer(marker);
                    }
                });
                map.addLayer(markers);
            });

        // Load seva feed
        function loadSevaFeed() {
            fetch('/api/seva/feed?limit=20')
                .then(res => res.json())
                .then(data => {
                    const feed = document.getElementById('seva-feed');
                    const count = document.getElementById('seva-count');
                    
                    if (data.length === 0) {
                        feed.innerHTML = '<p style="color: rgba(255,255,255,0.6);">No active seva requests at the moment.</p>';
                        count.textContent = '0';
                        return;
                    }

                    count.textContent = data.length;
                    feed.innerHTML = data.map(item => {
                        if (item.type === 'seva_request') {
                            return `
                                <div class="seva-item">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <strong>${item.title}</strong>
                                        <span style="background: rgba(249, 115, 22, 0.2); color: #f97316; padding: 2px 8px; border-radius: 8px; font-size: 12px; border: 1px solid rgba(249, 115, 22, 0.3);">${item.status}</span>
                                    </div>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin: 8px 0;">${item.description}</p>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 8px;">
                                        üìç ${item.village} | üìÖ ${new Date(item.created_at).toLocaleDateString()}
                                    </div>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                });
        }

        loadSevaFeed();
        setInterval(loadSevaFeed, 30000);

        function toggleSevaPanel() {
            document.getElementById('seva-panel').classList.toggle('expanded');
        }
    </script>
</body>
</html>
