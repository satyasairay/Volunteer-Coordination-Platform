<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satsangee District Map - Bhadrak, Odisha</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: calc(100vh - 64px); width: 100%; }
        #seva-feed-panel {
            position: fixed;
            right: 0;
            top: 64px;
            width: 380px;
            height: calc(100vh - 64px);
            background: white;
            box-shadow: -4px 0 24px rgba(0,0,0,0.1);
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        #seva-feed-panel.hidden {
            transform: translateX(100%);
        }
        .role-chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
        }
        .role-Volunteer { background: #dbeafe; color: #1e40af; }
        .role-Electrician { background: #fef3c7; color: #92400e; }
        .role-Plumber { background: #e0e7ff; color: #3730a3; }
        .role-Technician { background: #fce7f3; color: #831843; }
        .role-Lawyer { background: #f3e8ff; color: #6b21a8; }
        .role-Engineer { background: #dcfce7; color: #166534; }
        .urgency-critical { border-left: 4px solid #dc2626; }
        .urgency-high { border-left: 4px solid #f59e0b; }
        .urgency-medium { border-left: 4px solid #3b82f6; }
        .urgency-low { border-left: 4px solid #10b981; }
        .seva-item { 
            border-bottom: 1px solid #e5e7eb;
            padding: 12px;
            transition: background 0.2s;
        }
        .seva-item:hover { background: #f9fafb; }
        @media (max-width: 768px) {
            #seva-feed-panel { width: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm h-16 flex items-center px-4 md:px-8">
        <h1 class="text-xl font-bold text-gray-800 mr-6">üïâÔ∏è Seva Atlas</h1>
        <input 
            type="text" 
            id="search" 
            placeholder="Search villages or doctors..." 
            class="flex-1 max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
        />
        <button 
            id="bhadrak-btn" 
            class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
            üìç Bhadrak
        </button>
        <button 
            id="seva-feed-toggle" 
            class="ml-4 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
        >
            üôè Seva Feed
        </button>
        <a href="/doctors" class="ml-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            üë®‚Äç‚öïÔ∏è Doctors
        </a>
    </nav>

    <div id="map"></div>
    
    <!-- SEVA FEED PANEL -->
    <div id="seva-feed-panel">
        <div class="sticky top-0 bg-gradient-to-r from-orange-600 to-orange-500 text-white p-4">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-bold">üôè Live Seva Feed</h2>
                <button id="close-feed" class="text-white hover:text-gray-200">‚úï</button>
            </div>
            <p class="text-sm opacity-90 mt-1">Real-time service requests & responses</p>
        </div>
        
        <div id="feed-container" class="p-2">
            <div class="flex items-center justify-center py-8 text-gray-500">
                <div class="animate-spin h-8 w-8 border-4 border-orange-500 border-t-transparent rounded-full"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([20.5, 78.9], 4);

        // Base street map layer
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        });

        // Beautiful topographical/terrain layer
        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap (CC-BY-SA), Map data: ¬© OpenStreetMap contributors',
            maxZoom: 17
        });

        // Start with topo layer
        topoLayer.addTo(map);

        // Layer control for user to switch
        L.control.layers({
            "Topographical": topoLayer,
            "Street Map": streetLayer
        }, null, { position: 'topright' }).addTo(map);

        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false
        });

        let villagesData = [];

        fetch('/api/villages')
            .then(res => res.json())
            .then(villages => {
                villagesData = villages;
                villages.forEach(v => {
                    const marker = L.marker([v.lat, v.lng], {
                        title: v.name
                    });
                    
                    marker.villageId = v.id;
                    marker.villageName = v.name;
                    marker.villageBbox = v.bbox;
                    
                    marker.on('click', async () => {
                        const res = await fetch(`/api/village/${v.id}/volunteers`);
                        const members = await res.json();
                        
                        let content = `<div class="p-2"><h3 class="font-bold text-lg mb-2">${v.name}</h3>`;
                        content += `<p class="text-sm text-gray-600 mb-3">Block: ${v.block}</p>`;
                        
                        if (members.length === 0) {
                            content += '<p class="text-gray-500 italic">No verified volunteers yet</p>';
                        } else {
                            content += '<div class="space-y-2">';
                            members.forEach(m => {
                                content += `
                                    <div class="border-b pb-2">
                                        <div class="font-semibold">${m.full_name}</div>
                                        <span class="role-chip role-${m.role}">${m.role}</span>
                                        <div class="mt-1">
                                            <a href="tel:${m.phone}" class="text-blue-600 hover:underline text-sm">üìû ${m.phone}</a>
                                        </div>
                                        ${m.languages ? `<div class="text-xs text-gray-500 mt-1">Languages: ${m.languages}</div>` : ''}
                                    </div>
                                `;
                            });
                            content += '</div>';
                        }
                        content += '</div>';
                        
                        marker.bindPopup(content, { maxWidth: 300 }).openPopup();
                    });
                    
                    markers.addLayer(marker);
                });
                
                map.addLayer(markers);
            });

        document.getElementById('bhadrak-btn').addEventListener('click', () => {
            map.flyTo([20.8333, 86.9333], 9, {
                duration: 1.5
            });
        });

        document.getElementById('search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim().toLowerCase();
                
                const doctorKeywords = ['doctor', 'cardio', 'ortho', 'pediatric', 'surgeon', 'physician'];
                if (doctorKeywords.some(k => query.includes(k))) {
                    window.location.href = `/doctors?specialty=${encodeURIComponent(query)}`;
                    return;
                }
                
                const village = villagesData.find(v => 
                    v.name.toLowerCase().includes(query)
                );
                
                if (village) {
                    const bounds = [
                        [village.bbox[0], village.bbox[1]],
                        [village.bbox[2], village.bbox[3]]
                    ];
                    map.flyToBounds(bounds, {
                        maxZoom: 13,
                        duration: 1.5
                    });
                } else {
                    alert('Village not found. Try searching for doctors instead.');
                }
            }
        });

        // ==================================================
        // SEVA FEED FUNCTIONALITY
        // ==================================================
        
        const feedPanel = document.getElementById('seva-feed-panel');
        const feedToggle = document.getElementById('seva-feed-toggle');
        const closeButton = document.getElementById('close-feed');
        const feedContainer = document.getElementById('feed-container');
        
        // Toggle feed panel
        feedToggle.addEventListener('click', () => {
            feedPanel.classList.toggle('hidden');
            if (!feedPanel.classList.contains('hidden')) {
                loadSevaFeed();
            }
        });
        
        closeButton.addEventListener('click', () => {
            feedPanel.classList.add('hidden');
        });
        
        // Load seva feed
        async function loadSevaFeed() {
            try {
                const response = await fetch('/api/seva/feed?limit=20');
                const data = await response.json();
                renderFeed(data.feed);
            } catch (error) {
                feedContainer.innerHTML = '<div class="p-4 text-red-600">Error loading feed</div>';
            }
        }
        
        // Render feed items
        function renderFeed(feedItems) {
            if (!feedItems || feedItems.length === 0) {
                feedContainer.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <p class="text-4xl mb-3">üôè</p>
                        <p class="font-medium">No seva activity yet</p>
                        <p class="text-sm mt-2">Service requests and responses will appear here</p>
                    </div>
                `;
                return;
            }
            
            const html = feedItems.map(item => {
                if (item.type === 'request') {
                    return `
                        <div class="seva-item urgency-${item.urgency}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xl">${getSevaIcon(item.seva_type)}</span>
                                        <span class="font-semibold text-sm">${item.title}</span>
                                    </div>
                                    <div class="text-xs text-gray-600 mb-2">
                                        <span class="font-medium">${item.requested_by}</span> ‚Ä¢ ${item.village_name}
                                    </div>
                                    <div class="flex gap-2">
                                        <span class="px-2 py-0.5 bg-gray-100 text-xs rounded">${item.seva_type}</span>
                                        <span class="px-2 py-0.5 ${getUrgencyColor(item.urgency)} text-xs rounded font-medium">${item.urgency}</span>
                                        <span class="px-2 py-0.5 ${getStatusColor(item.status)} text-xs rounded">${item.status}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">${getTimeAgo(item.created_at)}</div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'response') {
                    return `
                        <div class="seva-item" style="border-left: 4px solid #10b981;">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xl">‚úã</span>
                                        <span class="font-semibold text-sm">Volunteer Responded</span>
                                    </div>
                                    <div class="text-xs text-gray-600 mb-2">
                                        <span class="font-medium">${item.volunteer_name}</span> volunteered for ${item.seva_type}
                                    </div>
                                    <div class="flex gap-2">
                                        <span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded">${item.status}</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400">${getTimeAgo(item.responded_at)}</div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'testimonial') {
                    return `
                        <div class="seva-item" style="border-left: 4px solid #f59e0b;">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xl">üíê</span>
                                        <span class="font-semibold text-sm">Gratitude</span>
                                    </div>
                                    <div class="text-xs text-gray-600 mb-2">
                                        <span class="font-medium">${item.author_name}</span>${item.village_name ? ' ‚Ä¢ ' + item.village_name : ''}
                                    </div>
                                    <div class="text-sm text-gray-700 italic">"${item.content}"</div>
                                </div>
                                <div class="text-xs text-gray-400">${getTimeAgo(item.created_at)}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            feedContainer.innerHTML = html;
        }
        
        // Helper functions
        function getSevaIcon(sevaType) {
            const icons = {
                'medical': 'üè•',
                'electrical': '‚ö°',
                'plumbing': 'üîß',
                'spiritual': 'üôè',
                'emergency': 'üö®',
                'other': 'üõ†Ô∏è'
            };
            return icons[sevaType] || 'üìã';
        }
        
        function getUrgencyColor(urgency) {
            const colors = {
                'critical': 'bg-red-100 text-red-700',
                'high': 'bg-orange-100 text-orange-700',
                'medium': 'bg-blue-100 text-blue-700',
                'low': 'bg-green-100 text-green-700'
            };
            return colors[urgency] || 'bg-gray-100 text-gray-700';
        }
        
        function getStatusColor(status) {
            const colors = {
                'open': 'bg-blue-100 text-blue-700',
                'assigned': 'bg-yellow-100 text-yellow-700',
                'in_progress': 'bg-purple-100 text-purple-700',
                'fulfilled': 'bg-green-100 text-green-700',
                'closed': 'bg-gray-100 text-gray-700'
            };
            return colors[status] || 'bg-gray-100 text-gray-700';
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000); // seconds
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return Math.floor(diff / 86400) + 'd ago';
        }
        
        // Auto-refresh feed every 30 seconds
        setInterval(() => {
            if (!feedPanel.classList.contains('hidden')) {
                loadSevaFeed();
            }
        }, 30000);
        
        // Load feed on page load
        loadSevaFeed();
    </script>
</body>
</html>
