<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satsangee District Map - Bhadrak, Odisha</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: calc(100vh - 64px); width: 100%; }
        .role-chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 4px;
        }
        .role-Volunteer { background: #dbeafe; color: #1e40af; }
        .role-Electrician { background: #fef3c7; color: #92400e; }
        .role-Plumber { background: #e0e7ff; color: #3730a3; }
        .role-Technician { background: #fce7f3; color: #831843; }
        .role-Lawyer { background: #f3e8ff; color: #6b21a8; }
        .role-Engineer { background: #dcfce7; color: #166534; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm h-16 flex items-center px-4 md:px-8">
        <h1 class="text-xl font-bold text-gray-800 mr-6">Satsangee Map</h1>
        <input 
            type="text" 
            id="search" 
            placeholder="Search villages or doctors..." 
            class="flex-1 max-w-md px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
        />
        <button 
            id="bhadrak-btn" 
            class="ml-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
            üìç Bhadrak
        </button>
        <a href="/doctors" class="ml-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            üë®‚Äç‚öïÔ∏è Doctors
        </a>
    </nav>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        const map = L.map('map').setView([20.5, 78.9], 4);

        // Base street map layer
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        });

        // Beautiful topographical/terrain layer
        const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap (CC-BY-SA), Map data: ¬© OpenStreetMap contributors',
            maxZoom: 17
        });

        // Start with topo layer
        topoLayer.addTo(map);

        // Layer control for user to switch
        L.control.layers({
            "Topographical": topoLayer,
            "Street Map": streetLayer
        }, null, { position: 'topright' }).addTo(map);

        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false
        });

        let villagesData = [];

        fetch('/api/villages')
            .then(res => res.json())
            .then(villages => {
                villagesData = villages;
                villages.forEach(v => {
                    const marker = L.marker([v.lat, v.lng], {
                        title: v.name
                    });
                    
                    marker.villageId = v.id;
                    marker.villageName = v.name;
                    marker.villageBbox = v.bbox;
                    
                    marker.on('click', async () => {
                        const res = await fetch(`/api/village/${v.id}/volunteers`);
                        const members = await res.json();
                        
                        let content = `<div class="p-2"><h3 class="font-bold text-lg mb-2">${v.name}</h3>`;
                        content += `<p class="text-sm text-gray-600 mb-3">Block: ${v.block}</p>`;
                        
                        if (members.length === 0) {
                            content += '<p class="text-gray-500 italic">No verified volunteers yet</p>';
                        } else {
                            content += '<div class="space-y-2">';
                            members.forEach(m => {
                                content += `
                                    <div class="border-b pb-2">
                                        <div class="font-semibold">${m.full_name}</div>
                                        <span class="role-chip role-${m.role}">${m.role}</span>
                                        <div class="mt-1">
                                            <a href="tel:${m.phone}" class="text-blue-600 hover:underline text-sm">üìû ${m.phone}</a>
                                        </div>
                                        ${m.languages ? `<div class="text-xs text-gray-500 mt-1">Languages: ${m.languages}</div>` : ''}
                                    </div>
                                `;
                            });
                            content += '</div>';
                        }
                        content += '</div>';
                        
                        marker.bindPopup(content, { maxWidth: 300 }).openPopup();
                    });
                    
                    markers.addLayer(marker);
                });
                
                map.addLayer(markers);
            });

        document.getElementById('bhadrak-btn').addEventListener('click', () => {
            map.flyTo([20.8333, 86.9333], 9, {
                duration: 1.5
            });
        });

        document.getElementById('search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value.trim().toLowerCase();
                
                const doctorKeywords = ['doctor', 'cardio', 'ortho', 'pediatric', 'surgeon', 'physician'];
                if (doctorKeywords.some(k => query.includes(k))) {
                    window.location.href = `/doctors?specialty=${encodeURIComponent(query)}`;
                    return;
                }
                
                const village = villagesData.find(v => 
                    v.name.toLowerCase().includes(query)
                );
                
                if (village) {
                    const bounds = [
                        [village.bbox[0], village.bbox[1]],
                        [village.bbox[2], village.bbox[3]]
                    ];
                    map.flyToBounds(bounds, {
                        maxZoom: 13,
                        duration: 1.5
                    });
                } else {
                    alert('Village not found. Try searching for doctors instead.');
                }
            }
        });
    </script>
</body>
</html>
