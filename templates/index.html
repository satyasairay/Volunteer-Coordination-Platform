<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seva Atlas - Bhadrak District</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #ffffff; }
        
        /* Navigation */
        nav {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #f97316;
        }
        
        .nav-location {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-left: 12px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
        }
        
        .nav-tab {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        
        .nav-tab:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.8);
        }
        
        .nav-tab:not(.active):hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Map container */
        #map-container {
            height: calc(100vh - 60px);
            width: 100%;
            position: relative;
        }
        
        svg { width: 100%; height: 100%; }
        
        /* Blocks */
        .block-path {
            stroke: #ffffff;
            stroke-width: 1.5;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .block-path:hover {
            stroke: #333;
            stroke-width: 2.5;
            filter: brightness(0.95);
        }
        
        .block-label {
            font-size: 13px;
            font-weight: 600;
            fill: #ffffff;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        /* Villages */
        .village-point {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .village-point:hover {
            r: 5 !important;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
        }
        
        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 12px;
            color: #666;
        }
        
        .legend-color {
            width: 30px;
            height: 18px;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 3px;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .tooltip.show { opacity: 1; }
        
        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            
            .nav-tabs {
                width: 100%;
                justify-content: center;
            }
            
            .nav-tab {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .legend {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 10px;
            }
            
            .zoom-controls {
                bottom: 20px;
                right: 20px;
            }
            
            .zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div style="display: flex; align-items: center;">
            <div class="nav-brand">
                üïâÔ∏è Seva Atlas
            </div>
            <span class="nav-location">üìç Bhadrak</span>
        </div>
        <div class="nav-tabs">
            <a href="/" class="nav-tab active">Map</a>
            <a href="/doctors" class="nav-tab">Doctors</a>
        </div>
    </nav>
    
    <div id="map-container">
        <div class="legend">
            <h3>Blocks (Population)</h3>
            <div id="legend-items"></div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" style="font-size: 16px;">‚ü≤</button>
        </div>
        
        <svg id="map"></svg>
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight - 60;
        
        const svg = d3.select("#map")
            .attr("viewBox", `0 0 ${width} ${height}`);
        
        let zoom = d3.zoom()
            .scaleExtent([1, 20])
            .on("zoom", zoomed);
        
        svg.call(zoom);
        
        let g = svg.append("g");
        let projection, path;
        let colorScale;
        let mapSettings = {};
        
        // Color scheme mappings
        const colorSchemes = {
            'Blues': d3.interpolateBlues,
            'Greens': d3.interpolateGreens,
            'Reds': d3.interpolateReds,
            'Purples': d3.interpolatePurples,
            'Oranges': d3.interpolateOranges,
            'Viridis': d3.interpolateViridis,
            'Turbo': d3.interpolateTurbo
        };
        
        // Load admin settings first
        fetch('/api/map-settings')
            .then(res => res.json())
            .then(settings => {
                mapSettings = settings;
                console.log('‚úÖ Map settings loaded:', settings);
                
                // Create color scale with admin-selected scheme
                const interpolator = colorSchemes[settings.color_scheme] || d3.interpolateBlues;
                colorScale = d3.scaleSequential()
                    .domain([160000, 260000])
                    .interpolator(interpolator);
                
                // Now load blocks
                loadBlocks();
            });
        
        function loadBlocks() {
        // Load blocks (small file, OK to load)
        fetch('/static/geojson/bhadrak_blocks.geojson')
            .then(res => res.json())
            .then(blocks => {
                // Create projection - fit Bhadrak to viewport using D3's fitSize
                projection = d3.geoMercator().fitSize([width * 0.9, height * 0.9], blocks);
                path = d3.geoPath().projection(projection);
                
                console.log('‚úÖ Map projection configured');
                
                // Draw blocks
                g.selectAll(".block")
                    .data(blocks.features)
                    .enter()
                    .append("path")
                    .attr("class", "block-path")
                    .attr("d", path)
                    .attr("fill", d => colorScale(d.properties.population || 200000))
                    .on("mouseover", showBlockTooltip)
                    .on("mouseout", hideTooltip);
                
                // Block labels
                g.selectAll(".block-label")
                    .data(blocks.features)
                    .enter()
                    .append("text")
                    .attr("class", "block-label")
                    .attr("transform", d => {
                        const centroid = path.centroid(d);
                        return `translate(${centroid[0]}, ${centroid[1]})`;
                    })
                    .text(d => d.properties.name);
                
                // Create legend
                createLegend(blocks.features);
                
                // Load villages (API returns lightweight data, not GeoJSON)
                loadVillages();
            });
        }
        
        function loadVillages() {
            if (!mapSettings.show_villages) {
                console.log('Villages disabled in admin settings');
                return;
            }
            
            fetch('/api/villages')
                .then(res => res.json())
                .then(villages => {
                    console.log(`‚úÖ Loaded ${villages.length} villages from API (not GeoJSON)`);
                    
                    // Draw village points (color from admin settings)
                    g.selectAll(".village")
                        .data(villages.filter(v => v.lat && v.lng && v.show_pin !== false))
                        .enter()
                        .append("circle")
                        .attr("class", "village-point")
                        .attr("cx", d => projection([d.lng, d.lat])[0])
                        .attr("cy", d => projection([d.lng, d.lat])[1])
                        .attr("r", 3)
                        .attr("fill", mapSettings.village_point_color || "#e63946")
                        .attr("stroke", "#ffffff")
                        .attr("stroke-width", 1)
                        .on("mouseover", showVillageTooltip)
                        .on("mouseout", hideTooltip)
                        .on("click", zoomToVillage);
                });
        }
        
        function createLegend(blocks) {
            const sorted = blocks.sort((a, b) => 
                (b.properties.population || 0) - (a.properties.population || 0)
            );
            
            const html = sorted.map(d => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colorScale(d.properties.population || 200000)}"></div>
                    <span>${d.properties.name}</span>
                </div>
            `).join('');
            
            document.getElementById('legend-items').innerHTML = html;
        }
        
        function showBlockTooltip(event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.html(`
                <strong>${d.properties.name}</strong><br>
                Population: ${d.properties.population?.toLocaleString() || 'N/A'}<br>
                Villages: ${d.properties.villages || 'N/A'}
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px")
            .classed("show", true);
        }
        
        function showVillageTooltip(event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.html(`
                <strong>${d.name}</strong><br>
                Block: ${d.block}
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px")
            .classed("show", true);
        }
        
        function hideTooltip() {
            d3.select("#tooltip").classed("show", false);
        }
        
        function zoomed(event) {
            g.attr("transform", event.transform);
        }
        
        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.5);
        }
        
        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 0.67);
        }
        
        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }
        
        function zoomToVillage(event, d) {
            const [x, y] = projection([d.lng, d.lat]);
            const scale = 10;
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
    </script>
</body>
</html>
