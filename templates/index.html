<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seva Atlas - Bhadrak District</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #ffffff; }
        
        /* Navigation */
        nav {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: #f97316;
        }
        
        .nav-location {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            margin-left: 12px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
        }
        
        .nav-tab {
            padding: 8px 20px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }
        
        .nav-tab:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.8);
        }
        
        .nav-tab:not(.active):hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Map container */
        #map-container {
            height: calc(100vh - 60px);
            width: 100%;
            position: relative;
        }
        
        svg { width: 100%; height: 100%; }
        
        /* District boundary */
        .district-boundary {
            fill: none;
            stroke: #333;
            stroke-width: 2;
            stroke-linejoin: round;
        }
        
        /* Villages */
        .village-polygon {
            stroke: #ffffff;
            stroke-width: 0.3;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.9;
        }
        
        .village-polygon:hover {
            stroke: #333;
            stroke-width: 1.5;
            filter: brightness(0.8);
            opacity: 1;
        }
        
        /* Legend */
        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 100;
            max-width: 200px;
        }
        
        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .legend-gradient {
            width: 100%;
            height: 20px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        
        /* Tooltip */
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .tooltip.show { opacity: 1; }
        
        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }
        
        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
            text-align: center;
        }
        
        .loading-progress {
            margin-top: 10px;
            font-size: 14px;
            color: #f97316;
            font-weight: 600;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            
            .nav-tabs {
                width: 100%;
                justify-content: center;
            }
            
            .nav-tab {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .legend {
                top: 10px;
                right: 10px;
                font-size: 11px;
                padding: 10px;
            }
            
            .zoom-controls {
                bottom: 20px;
                right: 20px;
            }
            
            .zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div style="display: flex; align-items: center;">
            <div class="nav-brand">
                üïâÔ∏è Seva Atlas
            </div>
            <span class="nav-location">üìç Bhadrak</span>
        </div>
        <div class="nav-tabs">
            <a href="/" class="nav-tab active">Map</a>
            <a href="/doctors" class="nav-tab">Doctors</a>
        </div>
    </nav>
    
    <div id="map-container">
        <div class="loading" id="loading">
            Loading Bhadrak map...
            <div class="loading-progress" id="loading-progress"></div>
        </div>
        
        <div class="legend" id="legend" style="display: none;">
            <h3>Population</h3>
            <div class="legend-gradient" id="legend-gradient"></div>
            <div class="legend-labels">
                <span id="legend-min">1,000</span>
                <span id="legend-max">20,000</span>
            </div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
            <button class="zoom-btn" onclick="resetZoom()" style="font-size: 16px;">‚ü≤</button>
        </div>
        
        <svg id="map"></svg>
        <div class="tooltip" id="tooltip"></div>
    </div>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight - 60;
        
        const svg = d3.select("#map")
            .attr("viewBox", `0 0 ${width} ${height}`);
        
        let zoom = d3.zoom()
            .scaleExtent([1, 20])
            .on("zoom", zoomed);
        
        svg.call(zoom);
        
        let g = svg.append("g");
        let projection, path;
        let colorScale;
        let mapSettings = {};
        
        // Color scheme mappings
        const colorSchemes = {
            'Blues': d3.interpolateBlues,
            'Greens': d3.interpolateGreens,
            'Reds': d3.interpolateReds,
            'Purples': d3.interpolatePurples,
            'Oranges': d3.interpolateOranges,
            'Viridis': d3.interpolateViridis,
            'Turbo': d3.interpolateTurbo
        };
        
        // Load admin settings first
        fetch('/api/map-settings')
            .then(res => res.json())
            .then(settings => {
                mapSettings = settings;
                console.log('‚úÖ Map settings loaded:', settings);
                
                // Create color scale with admin-selected scheme (use 0.4-0.95 range for saturated visible colors)
                const interpolator = colorSchemes[settings.color_scheme] || d3.interpolateBlues;
                colorScale = d3.scaleSequential()
                    .domain([1000, 20000])
                    .interpolator(t => interpolator(0.4 + t * 0.55));
                
                // Update legend gradient
                updateLegend();
                
                // Now load map
                loadMap();
            });
        
        function updateLegend() {
            const gradient = document.getElementById('legend-gradient');
            const scheme = mapSettings.color_scheme || 'Blues';
            gradient.style.background = `linear-gradient(to right, 
                ${colorScale(1000)}, 
                ${colorScale(10000)}, 
                ${colorScale(20000)})`;
        }
        
        async function loadMap() {
            try {
                // Step 1: Load and draw boundary first
                updateProgress('Loading district boundary...');
                const boundaryRes = await fetch('/static/geojson/bhadrak_boundary.geojson');
                const boundary = await boundaryRes.json();
                
                // DEBUG: Don't create projection yet, wait for villages
                // We'll create it after loading villages
                updateProgress('Boundary loaded');
                
                // Don't draw boundary yet - wait for projection from villages
                
                // Step 2: Load ALL villages (API returns cached data)
                const villagesRes = await fetch('/api/villages/choropleth');
                const villages = await villagesRes.json();
                
                console.log(`‚úÖ Loaded ${villages.features.length} villages`);
                
                // Create projection - fit to VILLAGES (not boundary!)
                projection = d3.geoMercator()
                    .fitExtent([[50, 50], [width - 50, height - 50]], villages);
                path = d3.geoPath().projection(projection);
                
                //  Now draw boundary with the villages-fitted projection
                g.append("path")
                    .datum(boundary)
                    .attr("class", "district-boundary")
                    .attr("d", path);
                
                updateProgress(`Rendering ${villages.features.length} villages...`);
                
                // Step 3: Draw ALL village polygons at once (D3 handles efficiently)
                updateProgress(`Rendering all ${villages.features.length} villages...`);
                
                const villagePaths = g.selectAll(".village-polygon")
                    .data(villages.features)
                    .enter()
                    .append("path")
                    .attr("class", "village-polygon")
                    .attr("d", d => {
                        const p = path(d);
                        if (!p) console.warn('No path for village:', d.properties.name);
                        return p;
                    })
                    .attr("fill", d => {
                        const color = colorScale(d.properties.population || 5000);
                        return color;
                    })
                    .attr("stroke", "#333")
                    .attr("stroke-width", 0.2)
                    .on("mouseover", showVillageTooltip)
                    .on("mouseout", hideTooltip)
                    .on("click", zoomToVillage);
                
                console.log(`‚úÖ Rendered ${villagePaths.size()} village polygons`);
                
                // Debug: Check if paths are being drawn
                const sampleVillage = villages.features[0];
                console.log('Sample village:', sampleVillage.properties.name);
                console.log('Sample path:', path(sampleVillage));
                console.log('Sample color:', colorScale(sampleVillage.properties.population));
                
                // Count actual path elements in SVG
                const pathCount = document.querySelectorAll('.village-polygon').length;
                console.log(`DOM has ${pathCount} village path elements`);
                
                // Show legend and hide loading
                document.getElementById('legend').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                console.log('‚úÖ Choropleth map complete!');
                
            } catch (error) {
                console.error('Error loading map:', error);
                document.getElementById('loading').innerHTML = `Error loading map<br><small>${error.message}</small>`;
            }
        }
        
        function updateProgress(message) {
            const progress = document.getElementById('loading-progress');
            if (progress) {
                progress.textContent = message;
            }
        }
        
        function showVillageTooltip(event, d) {
            const tooltip = d3.select("#tooltip");
            tooltip.html(`
                <strong>${d.properties.name}</strong><br>
                Block: ${d.properties.block}<br>
                Population: ${d.properties.population?.toLocaleString() || 'N/A'}
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px")
            .classed("show", true);
        }
        
        function hideTooltip() {
            d3.select("#tooltip").classed("show", false);
        }
        
        function zoomed(event) {
            g.attr("transform", event.transform);
        }
        
        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.5);
        }
        
        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 0.67);
        }
        
        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }
        
        function zoomToVillage(event, d) {
            const bounds = path.bounds(d);
            const dx = bounds[1][0] - bounds[0][0];
            const dy = bounds[1][1] - bounds[0][1];
            const x = (bounds[0][0] + bounds[1][0]) / 2;
            const y = (bounds[0][1] + bounds[1][1]) / 2;
            const scale = 0.9 / Math.max(dx / width, dy / height);
            const translate = [width / 2 - scale * x, height / 2 - scale * y];
            
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
    </script>
</body>
</html>
